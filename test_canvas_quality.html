<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas绘制质量测试</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .canvas-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .canvas-wrapper {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .canvas-title {
            background-color: #f8f9fa;
            padding: 10px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        canvas {
            display: block;
            background-color: white;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .info {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .device-info {
            background-color: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Canvas绘制质量测试</h1>
        
        <div class="device-info">
            <h3>设备信息</h3>
            <p>设备像素比 (devicePixelRatio): <span id="dpr">1</span></p>
            <p>屏幕尺寸: <span id="screen-size">-</span></p>
            <p>窗口尺寸: <span id="window-size">-</span></p>
        </div>

        <div class="info">
            <h3>测试说明</h3>
            <p>这个测试页面用于比较传统Canvas处理方式和新的CanvasManager处理方式的绘制质量差异。</p>
            <p>左侧使用传统方式，右侧使用CanvasManager方式。两种方式都应该在高DPI屏幕上显示清晰的图形。</p>
        </div>

        <div class="controls">
            <button onclick="drawTestPattern()">绘制测试图案</button>
            <button onclick="drawText()">绘制文字</button>
            <button onclick="drawCircles()">绘制圆形</button>
            <button onclick="drawLines()">绘制线条</button>
            <button onclick="clearCanvases()">清除画布</button>
        </div>

        <div class="canvas-container">
            <div class="canvas-wrapper">
                <div class="canvas-title">传统Canvas方式</div>
                <canvas id="traditional-canvas" width="400" height="300"></canvas>
            </div>
            <div class="canvas-wrapper">
                <div class="canvas-title">CanvasManager方式</div>
                <canvas id="manager-canvas" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- 引入JavaScript文件 -->
    <script src="CanvasManager.js"></script>
    <script>
        // 初始化设备信息显示
        function updateDeviceInfo() {
            document.getElementById('dpr').textContent = window.devicePixelRatio || 1;
            document.getElementById('screen-size').textContent = `${screen.width} x ${screen.height}`;
            document.getElementById('window-size').textContent = `${window.innerWidth} x ${window.innerHeight}`;
        }

        // 初始化CanvasManager
        let canvasManager = null;
        let traditionalCanvas = null;
        let managerCanvas = null;

        function initCanvases() {
            // 获取Canvas元素
            traditionalCanvas = document.getElementById('traditional-canvas');
            managerCanvas = document.getElementById('manager-canvas');

            // 初始化CanvasManager
            canvasManager = new CanvasManager();
            canvasManager.init(managerCanvas, {
                enableHighQuality: true,
                enablePixelAlignment: true,
                enableImageSmoothing: true,
                imageSmoothingQuality: 'high',
                backgroundColor: '#ffffff'
            });

            // 设置传统Canvas的样式
            const rect = traditionalCanvas.getBoundingClientRect();
            traditionalCanvas.style.width = rect.width + 'px';
            traditionalCanvas.style.height = rect.height + 'px';
            traditionalCanvas.width = rect.width * (window.devicePixelRatio || 1);
            traditionalCanvas.height = rect.height * (window.devicePixelRatio || 1);

            const ctx = traditionalCanvas.getContext('2d');
            ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
            ctx.translate(0.5, 0.5);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            console.log('Canvas初始化完成');
            console.log('传统Canvas尺寸:', {
                css: { width: rect.width, height: rect.height },
                pixel: { width: traditionalCanvas.width, height: traditionalCanvas.height }
            });
            console.log('CanvasManager尺寸:', canvasManager.getDisplaySize());
        }

        // 绘制测试图案
        function drawTestPattern() {
            clearCanvases();

            // 传统Canvas绘制
            const traditionalCtx = traditionalCanvas.getContext('2d');
            traditionalCtx.save();
            traditionalCtx.resetTransform();
            traditionalCtx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
            traditionalCtx.translate(0.5, 0.5);

            // 绘制网格
            traditionalCtx.strokeStyle = '#e0e0e0';
            traditionalCtx.lineWidth = 1;
            for (let i = 0; i <= 20; i++) {
                const x = i * 20;
                const y = i * 15;
                traditionalCtx.beginPath();
                traditionalCtx.moveTo(x, 0);
                traditionalCtx.lineTo(x, 300);
                traditionalCtx.stroke();
                traditionalCtx.beginPath();
                traditionalCtx.moveTo(0, y);
                traditionalCtx.lineTo(400, y);
                traditionalCtx.stroke();
            }

            // 绘制测试图形
            traditionalCtx.fillStyle = '#ff6b6b';
            traditionalCtx.fillRect(50, 50, 100, 80);

            traditionalCtx.fillStyle = '#4ecdc4';
            traditionalCtx.beginPath();
            traditionalCtx.arc(250, 100, 40, 0, Math.PI * 2);
            traditionalCtx.fill();

            traditionalCtx.strokeStyle = '#45b7d1';
            traditionalCtx.lineWidth = 3;
            traditionalCtx.beginPath();
            traditionalCtx.moveTo(50, 200);
            traditionalCtx.lineTo(350, 200);
            traditionalCtx.stroke();

            traditionalCtx.restore();

            // CanvasManager绘制
            const managerCtx = canvasManager.getContext();
            managerCtx.save();
            managerCtx.resetTransform();

            // 绘制网格
            managerCtx.strokeStyle = '#e0e0e0';
            managerCtx.lineWidth = 1;
            for (let i = 0; i <= 20; i++) {
                const x = i * 20;
                const y = i * 15;
                managerCtx.beginPath();
                managerCtx.moveTo(x, 0);
                managerCtx.lineTo(x, 300);
                managerCtx.stroke();
                managerCtx.beginPath();
                managerCtx.moveTo(0, y);
                managerCtx.lineTo(400, y);
                managerCtx.stroke();
            }

            // 绘制测试图形
            managerCtx.fillStyle = '#ff6b6b';
            managerCtx.fillRect(50, 50, 100, 80);

            managerCtx.fillStyle = '#4ecdc4';
            managerCtx.beginPath();
            managerCtx.arc(250, 100, 40, 0, Math.PI * 2);
            managerCtx.fill();

            managerCtx.strokeStyle = '#45b7d1';
            managerCtx.lineWidth = 3;
            managerCtx.beginPath();
            managerCtx.moveTo(50, 200);
            managerCtx.lineTo(350, 200);
            managerCtx.stroke();

            managerCtx.restore();
        }

        // 绘制文字
        function drawText() {
            clearCanvases();

            // 传统Canvas绘制
            const traditionalCtx = traditionalCanvas.getContext('2d');
            traditionalCtx.save();
            traditionalCtx.resetTransform();
            traditionalCtx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
            traditionalCtx.translate(0.5, 0.5);

            traditionalCtx.font = 'bold 24px "Microsoft YaHei", sans-serif';
            traditionalCtx.fillStyle = '#333';
            traditionalCtx.textAlign = 'center';
            traditionalCtx.fillText('Canvas质量测试', 200, 50);

            traditionalCtx.font = '16px "Microsoft YaHei", sans-serif';
            traditionalCtx.fillStyle = '#666';
            traditionalCtx.fillText('传统Canvas方式', 200, 100);

            traditionalCtx.font = '14px "Microsoft YaHei", sans-serif';
            traditionalCtx.fillText('设备像素比: ' + (window.devicePixelRatio || 1), 200, 130);

            traditionalCtx.restore();

            // CanvasManager绘制
            const managerCtx = canvasManager.getContext();
            managerCtx.save();
            managerCtx.resetTransform();

            managerCtx.font = 'bold 24px "Microsoft YaHei", sans-serif';
            managerCtx.fillStyle = '#333';
            managerCtx.textAlign = 'center';
            managerCtx.fillText('Canvas质量测试', 200, 50);

            managerCtx.font = '16px "Microsoft YaHei", sans-serif';
            managerCtx.fillStyle = '#666';
            managerCtx.fillText('CanvasManager方式', 200, 100);

            managerCtx.font = '14px "Microsoft YaHei", sans-serif';
            managerCtx.fillStyle = '#666';
            managerCtx.fillText('设备像素比: ' + (window.devicePixelRatio || 1), 200, 130);

            managerCtx.restore();
        }

        // 绘制圆形
        function drawCircles() {
            clearCanvases();

            // 传统Canvas绘制
            const traditionalCtx = traditionalCanvas.getContext('2d');
            traditionalCtx.save();
            traditionalCtx.resetTransform();
            traditionalCtx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
            traditionalCtx.translate(0.5, 0.5);

            for (let i = 0; i < 10; i++) {
                const x = 40 + i * 36;
                const y = 150;
                const radius = 15 + i * 2;
                
                traditionalCtx.beginPath();
                traditionalCtx.arc(x, y, radius, 0, Math.PI * 2);
                traditionalCtx.fillStyle = `hsl(${i * 36}, 70%, 60%)`;
                traditionalCtx.fill();
                traditionalCtx.strokeStyle = '#333';
                traditionalCtx.lineWidth = 1;
                traditionalCtx.stroke();
            }

            traditionalCtx.restore();

            // CanvasManager绘制
            const managerCtx = canvasManager.getContext();
            managerCtx.save();
            managerCtx.resetTransform();

            for (let i = 0; i < 10; i++) {
                const x = 40 + i * 36;
                const y = 150;
                const radius = 15 + i * 2;
                
                managerCtx.beginPath();
                managerCtx.arc(x, y, radius, 0, Math.PI * 2);
                managerCtx.fillStyle = `hsl(${i * 36}, 70%, 60%)`;
                managerCtx.fill();
                managerCtx.strokeStyle = '#333';
                managerCtx.lineWidth = 1;
                managerCtx.stroke();
            }

            managerCtx.restore();
        }

        // 绘制线条
        function drawLines() {
            clearCanvases();

            // 传统Canvas绘制
            const traditionalCtx = traditionalCanvas.getContext('2d');
            traditionalCtx.save();
            traditionalCtx.resetTransform();
            traditionalCtx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
            traditionalCtx.translate(0.5, 0.5);

            traditionalCtx.strokeStyle = '#333';
            traditionalCtx.lineWidth = 2;
            
            // 绘制不同角度的线条
            for (let i = 0; i < 8; i++) {
                const angle = (i * Math.PI) / 4;
                const length = 100;
                const centerX = 200;
                const centerY = 150;
                
                traditionalCtx.beginPath();
                traditionalCtx.moveTo(centerX, centerY);
                traditionalCtx.lineTo(
                    centerX + Math.cos(angle) * length,
                    centerY + Math.sin(angle) * length
                );
                traditionalCtx.stroke();
            }

            traditionalCtx.restore();

            // CanvasManager绘制
            const managerCtx = canvasManager.getContext();
            managerCtx.save();
            managerCtx.resetTransform();

            managerCtx.strokeStyle = '#333';
            managerCtx.lineWidth = 2;
            
            // 绘制不同角度的线条
            for (let i = 0; i < 8; i++) {
                const angle = (i * Math.PI) / 4;
                const length = 100;
                const centerX = 200;
                const centerY = 150;
                
                managerCtx.beginPath();
                managerCtx.moveTo(centerX, centerY);
                managerCtx.lineTo(
                    centerX + Math.cos(angle) * length,
                    centerY + Math.sin(angle) * length
                );
                managerCtx.stroke();
            }

            managerCtx.restore();
        }

        // 清除画布
        function clearCanvases() {
            // 清除传统Canvas
            const traditionalCtx = traditionalCanvas.getContext('2d');
            traditionalCtx.save();
            traditionalCtx.resetTransform();
            traditionalCtx.clearRect(0, 0, traditionalCanvas.width, traditionalCanvas.height);
            traditionalCtx.restore();

            // 清除CanvasManager
            canvasManager.clear();
        }

        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            updateDeviceInfo();
            initCanvases();
            drawTestPattern();
        });

        // 窗口大小变化时更新设备信息
        window.addEventListener('resize', updateDeviceInfo);
    </script>
</body>
</html>